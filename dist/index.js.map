{"version":3,"sources":["../src/index.js","../src/config.js"],"sourcesContent":["import { URL } from 'url';\nimport * as core from '@actions/core';\nimport { getInput } from './config.js';\nimport { generate } from 'critical';\nimport nodeRsync from 'rsyncwrapper';\nimport fs from 'fs';\nimport * as ChromeLauncher from 'chrome-launcher';\n\nconst cleanOldCriticalFiles = async (options) => {\n  core.startGroup('Clean up');\n  fs.mkdirSync(options.src);\n  nodeRsync(\n    options,\n    (error, stdout, stderr, cmd) => {\n      if (error) {\n        core.error(error);\n        core.error(stdout);\n        core.error(stderr);\n        core.error(cmd);\n        process.exit(1);\n      } else {\n        core.info('Rsync cleanup finished');\n        core.info(stdout);\n      }\n    }\n  );\n  core.endGroup();\n};\n\nconst generateCriticalCSS = async (input) => {\n  for (let page of input.paths) {\n    console.log(page);\n    const pageUrl = new URL(`${input.baseUrl}${page.url}`);\n    const criticalDest =\n      input.destinationPath + page.template + '_critical.min.css';\n\n    core.info(`Generating critical CSS: ${pageUrl.href} -> ${criticalDest}`);\n\n    async function getBrowser() {\n      return ChromeLauncher.launch({\n        chromeFlags: ['--headless=new']\n      });\n    }\n\n    await generate({\n      src: pageUrl.href,\n      target: criticalDest,\n      inline: false,\n      penthouse: {\n        chromeFlags: {}\n      },\n      ignore: [],\n      //   minify: true,\n      dimensions: [\n        {\n          width: 375,\n          height: 667\n        },\n        {\n          width: 1440,\n          height: 1280\n        }\n      ]\n    });\n  }\n};\n\nconst main = async () => {\n  core.startGroup('Action config');\n  const input = getInput();\n  process.env.PUPPETEER_EXECUTABLE_PATH = input.browserPath;\n\n  let options = {\n    src: input.destinationPath,\n    dest: `${input.syncOptions.sshHost}:${input.syncOptions.targetDir}`,\n    args: ['-azhcvv'],\n    delete: true,\n    ssh: true,\n    port: input.syncOptions.sshPort\n  };\n\n  if (input.syncOptions.sshPrivateKeyPath.length) {\n    options['privateKey'] = input.syncOptions.sshPrivateKeyPath;\n  }\n\n  core.endGroup(); // Action config\n\n  await cleanOldCriticalFiles(options);\n\n  core.startGroup('Start Critical CSS');\n  await generateCriticalCSS(input);\n  core.endGroup();\n\n  if (input.shouldSync) {\n    core.startGroup(\n      `Starting Rsync ${input.destinationPath} -> ${input.syncOptions.targetDir}`\n    );\n\n    nodeRsync(\n      options,\n      (error, stdout, stderr, cmd) => {\n        if (error) {\n          core.error(error);\n          core.error(stdout);\n          core.error(stderr);\n          core.error(cmd);\n          process.exit(1);\n        } else {\n          core.info('Rsync finished');\n          core.info(stdout);\n        }\n      }\n    );\n    core.endGroup();\n  }\n};\n\nmain()\n  .catch((err) => {\n    core.setFailed(err.message);\n    process.exit(1);\n  })\n  .then(() => core.debug(`done in ${process.uptime()}s`));\n","import core from '@actions/core';\nimport fs from 'fs';\nimport { resolve } from 'path';\nimport { Launcher as chromeLauncher } from 'chrome-launcher';\n\nexport function getInput() {\n  let serverBaseUrl = core.getInput('serverBaseUrl');\n  if (!serverBaseUrl) {\n    // Fail and exit\n    core.setFailed(`Need a valid base url.`);\n    process.exit(1);\n  }\n\n  // Make sure we end with a '/'\n  if (serverBaseUrl.substr(-1) !== '/') {\n    serverBaseUrl += '/';\n  }\n\n  const destinationPath = core.getInput('destinationPath');\n  if (!destinationPath) {\n    // Fail and exit\n    core.setFailed(`Need a valid destination path.`);\n    process.exit(1);\n  }\n\n  const configPath = core.getInput('configPath')\n    ? resolve(core.getInput('configPath'))\n    : null;\n\n  if (!configPath) {\n    // Fail and exit\n    core.setFailed(`Config file not found or invalid configPath.`);\n    process.exit(1);\n  }\n\n  const config = JSON.parse(fs.readFileSync(configPath));\n  if (!config.length) {\n    core.setFailed(`Invalid config.`);\n    process.exit(1);\n  }\n\n  const browserPath = chromeLauncher.getFirstInstallation();\n\n\n  const shouldSync = core.getInput('sync');\n\n  let syncOptions = {};\n  if (shouldSync) {\n    const sshPrivateKeyPath = core.getInput('sshPrivateKeyPath');\n    const sshHost = core.getInput('sshHost');\n    const sshPort = core.getInput('sshPort');\n    const targetDir = core.getInput('targetDir');\n\n    if (!sshHost || !targetDir) {\n      core.setFailed(`Invalid ssh options provided.`);\n      process.exit(1);\n    }\n\n    syncOptions = {\n      sshPrivateKeyPath: sshPrivateKeyPath,\n      sshHost: sshHost,\n      sshPort: sshPort,\n      targetDir: targetDir,\n    };\n  }\n\n  return {\n    baseUrl: serverBaseUrl,\n    destinationPath: destinationPath,\n    paths: config,\n    browserPath: browserPath,\n    shouldSync: shouldSync,\n    syncOptions: syncOptions,\n  };\n}\n"],"mappings":"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","names":["URL","core","core","fs","resolve","chromeLauncher","getInput","serverBaseUrl","destinationPath","configPath","config","browserPath","shouldSync","syncOptions","sshPrivateKeyPath","sshHost","sshPort","targetDir","generate","nodeRsync","fs","ChromeLauncher","cleanOldCriticalFiles","options","error","stdout","stderr","cmd","generateCriticalCSS","input","page","pageUrl","URL","criticalDest","getBrowser","main","getInput","err"]}