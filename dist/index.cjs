"use strict";var v=Object.create;var f=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var F=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of b(t))!w.call(e,i)&&i!==r&&f(e,i,{get:()=>t[i],enumerable:!(n=S(t,i))||n.enumerable});return e};var c=(e,t,r)=>(r=e!=null?v(O(e)):{},F(t||!e||!e.__esModule?f(r,"default",{value:e,enumerable:!0}):r,e));var y=require("url"),s=c(require("@actions/core"),1);var o=c(require("@actions/core"),1),p=c(require("fs/promises"),1),d=require("path"),g=require("chrome-launcher"),I=async()=>{let e=o.default.getInput("sshPrivateKey");e||(o.default.setFailed("Sync enabled, but no sshPrivateKey supplied."),process.exit(1));let t=o.default.getInput("sshHost");t||(o.default.setFailed("Sync enabled, but no sshHost supplied."),process.exit(1));let r=o.default.getInput("sshPort");r||(o.default.setFailed("Sync enabled, but no sshPort supplied."),process.exit(1));let n=o.default.getInput("targetDir");n||(o.default.setFailed("Sync enabled, but no targetDir supplied."),process.exit(1));let i="./key";return e.length&&await p.default.writeFile(i,`${e}
`,{mode:384,encoding:"utf8"}),(!t||!n)&&(o.default.setFailed("Invalid ssh options provided."),process.exit(1)),{sshPrivateKey:i,sshHost:t,sshPort:r,targetDir:n}};async function u(){let e=o.default.getInput("serverBaseUrl");e||(o.default.setFailed("Need a valid base url."),process.exit(1)),e.substring(-1)!=="/"&&(e+="/");let t=o.default.getInput("destinationPath");t||(o.default.setFailed("Need a valid destination path."),process.exit(1));let r=o.default.getInput("configPath")?(0,d.resolve)(o.default.getInput("configPath")):null;r||(o.default.setFailed("Config file not found or invalid configPath."),process.exit(1));let n=JSON.parse(await p.default.readFile(r,"utf-8"));n.length||(o.default.setFailed("Invalid config."),process.exit(1));let i=g.Launcher.getFirstInstallation(),a=o.default.getInput("sync")==="true",l=null;return a&&(l=await I()),{baseUrl:e,destinationPath:t,paths:n,browserPath:i,shouldSync:a,syncOptions:l}}var m=require("critical"),h=c(require("rsyncwrapper"),1),P=c(require("fs/promises"),1),x=e=>{let t=null;return e.shouldSync&&e.syncOptions!==null&&(t={src:e.destinationPath,dest:`${e.syncOptions.sshHost}:${e.syncOptions.targetDir}`,args:["-azhcvv"],delete:!0,ssh:!0,port:e.syncOptions.sshPort,privateKey:e.syncOptions.sshPrivateKey}),t},C=async e=>{s.startGroup("Clean up"),await P.default.mkdir(e.src),(0,h.default)(e,(t,r,n,i)=>{t?(s.error(t),s.error(r),s.error(n),s.error(i),process.exit(1)):(s.info("Rsync cleanup finished"),s.info(r))}),s.endGroup()},R=async e=>{for(let t of e.paths){let r=new y.URL(`${e.baseUrl}${t.url}`),n=e.destinationPath+t.template+"_critical.min.css";s.info(`Generating critical CSS: ${r.href} -> ${n}`),await(0,m.generate)({src:r.href,target:n,inline:!1,penthouse:{chromeFlags:{}},ignore:[],dimensions:[{width:375,height:667},{width:1440,height:1280}]})}},$=async()=>{var r;s.startGroup("Action config");let e=await u();process.env.PUPPETEER_EXECUTABLE_PATH=e.browserPath;let t=x(e);s.endGroup(),t!==null&&await C(t),s.startGroup("Start Critical CSS"),await R(e),s.endGroup(),e.shouldSync&&t!==null&&(s.startGroup(`Starting Rsync ${e.destinationPath} -> ${(r=e==null?void 0:e.syncOptions)==null?void 0:r.targetDir}`),(0,h.default)(t,(n,i,a,l)=>{n?(s.error(n),s.error(i),s.error(a),s.error(l),process.exit(1)):(s.info("Rsync finished"),s.info(i))}),s.endGroup())};$().catch(e=>{s.setFailed(e.message),process.exit(1)}).then(()=>s.debug(`done in ${process.uptime()}s`));
//# sourceMappingURL=index.cjs.map